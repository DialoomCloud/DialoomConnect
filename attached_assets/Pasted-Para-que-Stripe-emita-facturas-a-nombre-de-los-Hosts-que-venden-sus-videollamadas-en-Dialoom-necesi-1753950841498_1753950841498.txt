Para que Stripe emita facturas a nombre de los Hosts que venden sus videollamadas en Dialoom, necesitas usar Stripe Connect con cuentas tipo Standard o Express, y asegurarte de configurar correctamente la integración de facturación. Aquí tienes los pasos clave:

⸻

✅ 1. Activar Stripe Connect con soporte para facturación

Debes registrar a cada Host como un Connected Account. En Dialoom esto ya está contemplado en el roadmap como la tarea #202 | Stripe Connect onboarding ￼.

⸻

✅ 2. Crear cuentas Connect por cada Host

Cada vez que un usuario se convierte en Host (POST /hosts), debes lanzar el onboarding de Stripe Connect para su cuenta.

Esto implica usar la API de Stripe:

const account = await stripe.accounts.create({
  type: 'express', // o 'standard'
  country: 'ES',
  email: host.email,
  capabilities: {
    card_payments: { requested: true },
    transfers: { requested: true },
  },
});

Y luego redirigir al usuario a:

const link = await stripe.accountLinks.create({
  account: account.id,
  refresh_url: '<your_app>/reauth',
  return_url: '<your_app>/dashboard',
  type: 'account_onboarding',
});


⸻

✅ 3. Asociar los pagos a cada cuenta Connect

Cuando un cliente reserva una videollamada (POST /bookings), debes pasar el stripeAccount del Host en el checkout:

const session = await stripe.checkout.sessions.create({
  mode: 'payment',
  line_items: [...],
  success_url: '...',
  cancel_url: '...',
  payment_intent_data: {
    application_fee_amount: Math.round(total * 0.10), // tu comisión
  },
}, {
  stripeAccount: host.stripeAccountId, // ← clave
});

Esto asegura que el dinero se transfiere directamente al Host, y tú cobras la comisión.

⸻

✅ 4. Activar facturación automática en las cuentas Connect

Stripe solo emite facturas automáticas si:
	•	El Host tiene habilitado el módulo de Invoicing.
	•	El pago se hace con automatic_tax: true y los datos de cliente son válidos.
	•	Se ha configurado un default_tax_rates si aplica.

Esto se configura en el dashboard del Host (si es tipo Standard) o mediante API si es Express.

⸻

✅ 5. Guardar y mostrar facturas en Dialoom

Las facturas generadas por Stripe se guardan en la tabla Invoice en Dialoom (booking → invoice), incluyendo el PDF y el estado (DRAFT, SENT, PAID) ￼.

model Invoice {
  id              Int      @id @default(autoincrement())
  booking         Booking  @relation(fields: [bookingId], references: [id])
  bookingId       Int      @unique
  stripeInvoiceId String
  pdfUrl          String
  amount          Decimal
  currency        String
  status          InvoiceStatus
  createdAt       DateTime @default(now())
}


⸻

✅ 6. Activar Webhooks para sincronizar eventos

En la guía de despliegue ya está previsto el webhook de Stripe para los eventos clave como:
	•	checkout.session.completed
	•	invoice.paid
	•	account.updated ￼

Estos webhooks te permiten sincronizar la DB interna con el estado de Stripe.

⸻

✅ 7. (Opcional) Mostrar las facturas al Host

En el dashboard del Host puedes permitir acceso a sus facturas generadas, por ejemplo:
	•	Acceso a PDF (invoice.pdfUrl)
	•	Estado (invoice.status)
	•	Monto y moneda

⸻

¿Quieres que te genere el flujo completo de onboarding + factura automática en NestJS, incluyendo controladores y servicios?